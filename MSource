import maya.cmds as cmds
import maya.mel as mel
from maya.common.ui import LayoutManager

def appendButtonAction(*args):
    '''
    追加ボタンを押した際のイベント       
    ''' 
    selectingObjs = cmds.ls(sl = True, assemblies = True)
    scrollListObjs = cmds.textScrollList('SelectingObjList', query=True, allItems=True)
    selectingReferenceObjs = cmds.ls(type='reference')

    if not selectingObjs:
        cmds.inViewMessage(amg='<hl> ルートのオブジェクトが選択されていません </hl>', pos='midCenter', fade=True )
        cmds.warning('ルートのオブジェクトが選択されていません')
        return
        
    if scrollListObjs is None:
        scrollListObjs = []
                
    addObjList = list(set(selectingObjs) - set(scrollListObjs))
    
    print(addObjList)
    
    nodelist = cmds.ls(type='reference')
    for node in nodelist:
        RNnode = cmds.referenceQuery(node, referenceNode=True)
        Result = cmds.referenceQuery(RNnode, nodes=True)
        addObjList = list(set(addObjList) - set(Result))
    print(addObjList)
    
    cmds.textScrollList('SelectingObjList',edit=1,a=addObjList)    

    
def removeButtonAction(*args):
    '''
    削除ボタンを押した際のイベント       
    ''' 
    selectedItems = cmds.textScrollList('SelectingObjList', query=True, selectItem=True)
    if selectedItems:
        cmds.textScrollList('SelectingObjList', edit=True, removeItem=selectedItems)
    else:
        cmds.inViewMessage(amg='<hl> リストの項目が選択されていません </hl>', pos='midCenter', fade=True) 
    



def deleteItems(*args):
    '''アイテム削除    
    シーン内のグローバル直下のオブジェクトから登録オブジェクトを除き、削除       
    '''
    cantDeleteObjList = ['persp', 'side', 'front', 'top']
    
           
    allObjList = cmds.ls(assemblies = True)
    remainObjList = cmds.textScrollList('SelectingObjList', q=1, ai=1)
    if remainObjList is None:
       cmds.inViewMessage(amg='<hl>リストに消さないルートのオブジェクトを登録してください</hl>', pos='midCenter', fade=True )
       cmds.warning('リストに消さないルートのオブジェクトを登録してください') 
       return  
    deleteObjList = list(set(allObjList) - set(remainObjList) - set(cantDeleteObjList))
    
    if not deleteObjList:
       cmds.inViewMessage(amg='ルートに消すオブジェクトがありませんでした', pos='midCenter', fade=True )
       mel.eval('print("ルートに消すオブジェクトがありませんでした")')
       return
        
    cmds.delete(deleteObjList)
    cmds.inViewMessage(amg='リスト以外のルートを削除しました', pos='midCenter', fade=True )
    mel.eval('print("リスト以外のルートを削除しました")')
     
    
def main():
    windowName = "delete_manager"

    if cmds.window(windowName, q=True, exists=True):
        cmds.deleteUI(windowName, window=True)

    window = cmds.window(windowName)

    with LayoutManager(cmds.formLayout(numberOfDivisions=100)) as form:
        textScrollList = cmds.textScrollList('SelectingObjList', allowMultiSelection = 1)
        with LayoutManager(cmds.columnLayout(adj=True, rowSpacing=10)) as column:
            with LayoutManager(cmds.rowLayout(numberOfColumns=2)):
                cmds.button(label="追加", command = appendButtonAction)
                cmds.button(label="排除", command = removeButtonAction)
            cmds.button(label="実行", command = deleteItems)

        cmds.formLayout( form, edit=True, 
            attachForm=[(textScrollList, 'top', 5), (textScrollList, 'left', 5), (column, 'left', 5), (column, 'bottom', 5), (column, 'right', 5),], 
            attachControl=[ (textScrollList, 'bottom', 5, column)], 
            attachPosition=[(textScrollList, 'right', 5, 100)],)

        cmds.showWindow( window )

main()
